---
phase: 05-cursor-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/state/animate.rs
  - src/state/mod.rs
autonomous: true

must_haves:
  truths:
    - "Multiple animations at same FPS share a single timer"
    - "Timer starts when first subscriber, stops when last unsubscribes"
    - "Blink phase signal toggles on/off at configured rate"
  artifacts:
    - path: "src/state/animate.rs"
      provides: "Blink animation system with shared clocks"
      min_lines: 120
      exports: ["subscribe_to_blink", "get_blink_phase"]
  key_links:
    - from: "src/state/animate.rs"
      to: "spark_signals::Signal"
      via: "blink phase signal"
      pattern: "Signal<bool>"
---

<objective>
Create the blink animation system with shared clocks per FPS.

Purpose: All cursor blink animations (and future spinners/progress) at the same FPS should share a single timer for efficiency and visual sync.

Output: `src/state/animate.rs` with `subscribe_to_blink()` and `get_blink_phase()` functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cursor-system/05-CONTEXT.md
@.planning/phases/05-cursor-system/05-RESEARCH.md
@src/state/focus.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blink animation module</name>
  <files>src/state/animate.rs, src/state/mod.rs</files>
  <action>
Create `src/state/animate.rs` with the blink animation system:

1. **BlinkRegistry struct** - Per-FPS registry containing:
   - `phase: Signal<bool>` - true = visible, false = hidden
   - `handle: Option<JoinHandle<()>>` - Background timer thread
   - `running: Arc<AtomicBool>` - Flag to stop timer
   - `subscribers: usize` - Reference count

2. **Thread-local storage** - `BLINK_REGISTRIES: RefCell<HashMap<u8, BlinkRegistry>>`

3. **subscribe_to_blink(fps: u8) -> Box<dyn FnOnce()>** function:
   - If fps == 0, return no-op unsubscribe
   - Get or create registry for this FPS
   - Increment subscriber count
   - If first subscriber, start timer thread:
     - Calculate interval: `1000 / fps / 2` ms (divide by 2 for on/off cycle)
     - Spawn thread that loops while `running` is true
     - Each iteration: sleep, then toggle phase signal
   - Return unsubscribe closure that:
     - Decrements subscriber count
     - If count reaches 0, sets `running` to false and resets phase to true

4. **get_blink_phase(fps: u8) -> bool** function:
   - Returns current phase for the given FPS (true if no registry)

5. **reset_blink_registries()** for testing cleanup

Reference TypeScript drawnCursor.ts lines 88-140 for the pattern.

Update `src/state/mod.rs` to export the new module.
  </action>
  <verify>
  ```bash
  cargo build -p spark-tui 2>&1 | head -30
  cargo test -p spark-tui animate --no-fail-fast 2>&1 | tail -50
  ```
  </verify>
  <done>
  - `subscribe_to_blink()` returns unsubscribe function
  - Multiple subscriptions at same FPS share one timer
  - Timer stops and phase resets when all unsubscribe
  - Tests pass for subscribe/unsubscribe lifecycle
  </done>
</task>

<task type="auto">
  <name>Task 2: Add blink animation tests</name>
  <files>src/state/animate.rs</files>
  <action>
Add comprehensive tests to `src/state/animate.rs`:

1. **test_subscribe_returns_unsubscribe** - Subscribe returns callable closure

2. **test_shared_clock_same_fps** - Two subscriptions at 2 FPS share one timer (verify only one registry exists)

3. **test_different_fps_separate_clocks** - Subscriptions at 2 FPS and 4 FPS get separate registries

4. **test_phase_toggles** - Phase signal toggles after sleep (use small FPS like 20 for faster test)

5. **test_unsubscribe_stops_timer** - After all unsubscribe, timer stops (verify by checking running flag)

6. **test_resubscribe_restarts_timer** - After all unsubscribe then new subscribe, timer restarts

7. **test_zero_fps_noop** - fps=0 returns no-op, doesn't create registry

Each test should call `reset_blink_registries()` in setup to ensure clean state.
  </action>
  <verify>
  ```bash
  cargo test -p spark-tui animate -- --test-threads=1 2>&1 | tail -50
  ```
  </verify>
  <done>
  - All 7 tests pass
  - Tests run with single thread (to avoid timer race conditions)
  - No memory leaks or dangling threads
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
cargo build -p spark-tui

# All animate tests pass
cargo test -p spark-tui animate -- --test-threads=1

# Module exports correctly
grep -r "subscribe_to_blink" src/state/mod.rs
```
</verification>

<success_criteria>
- [ ] `src/state/animate.rs` exists with BlinkRegistry and shared clock pattern
- [ ] `subscribe_to_blink()` starts timer on first subscriber
- [ ] Timer stops when last subscriber unsubscribes
- [ ] `get_blink_phase()` returns current phase for given FPS
- [ ] All tests pass
- [ ] No compiler warnings
</success_criteria>

<output>
After completion, create `.planning/phases/05-cursor-system/05-01-SUMMARY.md`
</output>
