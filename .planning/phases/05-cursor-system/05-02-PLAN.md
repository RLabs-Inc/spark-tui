---
phase: 05-cursor-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/state/cursor.rs
  - src/state/mod.rs
  - src/engine/arrays/interaction.rs
autonomous: true

must_haves:
  truths:
    - "Terminal cursor can be positioned, shown, hidden"
    - "Cursor shape can be set to block, bar, or underline"
    - "Cursor state persists across render cycles"
  artifacts:
    - path: "src/state/cursor.rs"
      provides: "Terminal native cursor API wrapper"
      min_lines: 80
      exports: ["cursor_show", "cursor_hide", "cursor_move_to", "cursor_set_shape", "cursor_save", "cursor_restore"]
    - path: "src/engine/arrays/interaction.rs"
      provides: "cursor_char, cursor_alt_char arrays"
      contains: "CURSOR_CHAR"
  key_links:
    - from: "src/state/cursor.rs"
      to: "src/renderer/ansi.rs"
      via: "ANSI escape sequence helpers"
      pattern: "ansi::cursor"
---

<objective>
Create the terminal native cursor API and add missing cursor arrays.

Purpose: Provide a clean API for terminal cursor control and add cursor_char/cursor_alt_char arrays needed for drawn cursor configuration.

Output: `src/state/cursor.rs` module and updated interaction arrays.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cursor-system/05-CONTEXT.md
@.planning/phases/05-cursor-system/05-RESEARCH.md
@src/renderer/ansi.rs
@src/engine/arrays/interaction.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create terminal cursor module</name>
  <files>src/state/cursor.rs, src/state/mod.rs</files>
  <action>
Create `src/state/cursor.rs` wrapping the existing ANSI cursor functions with a cleaner API:

1. **Re-export CursorShape from ansi.rs** (or define if not already)

2. **Thread-local cursor state**:
   ```rust
   struct CursorState {
       visible: bool,
       shape: CursorShape,
       x: u16,
       y: u16,
   }
   ```

3. **Public API functions** (all write to stdout immediately):
   - `cursor_show()` - Show terminal cursor, update state
   - `cursor_hide()` - Hide terminal cursor, update state
   - `cursor_move_to(x: u16, y: u16)` - Position cursor, update state
   - `cursor_set_shape(shape: CursorShape, blinking: bool)` - Set shape
   - `cursor_save()` - Save cursor position (DEC)
   - `cursor_restore()` - Restore cursor position (DEC)

4. **State query functions**:
   - `cursor_is_visible() -> bool`
   - `cursor_position() -> (u16, u16)`
   - `cursor_shape() -> CursorShape`

5. **Reset function for testing**:
   - `reset_cursor_state()` - Reset to defaults (visible, block, 0,0)

Each function should:
- Update internal state
- Call appropriate `ansi::cursor_*` function
- Flush stdout

Update `src/state/mod.rs` to export the cursor module.
  </action>
  <verify>
  ```bash
  cargo build -p spark-tui 2>&1 | head -30
  grep -r "pub fn cursor_" src/state/cursor.rs | head -10
  ```
  </verify>
  <done>
  - `cursor_show/hide/move_to/set_shape/save/restore` functions exist
  - Functions update internal state and call ANSI helpers
  - Module exported from state/mod.rs
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cursor character arrays</name>
  <files>src/engine/arrays/interaction.rs</files>
  <action>
Add missing cursor arrays to `src/engine/arrays/interaction.rs`:

1. **CURSOR_CHAR** - `TrackedSlotArray<u32>` with default 0
   - Stores the cursor character codepoint
   - 0 = block (special case: inverse rendering)
   - 0x2502 = bar (â”‚)
   - 0x5F = underline (_)

2. **CURSOR_ALT_CHAR** - `TrackedSlotArray<u32>` with default 0
   - Stores alternate character for blink "off" phase
   - 0 = show original text character (default)
   - Non-zero = show this character

3. **CURSOR_STYLE** - `TrackedSlotArray<u8>` with default 0
   - 0 = Block, 1 = Bar, 2 = Underline
   - Allows renderer to know which style without parsing char

Add to:
- Thread-local declarations
- `ensure_capacity()` function
- `clear_at_index()` function
- `reset()` function

Add accessor functions:
- `get_cursor_char(index) -> u32`
- `set_cursor_char(index, char)`
- `get_cursor_alt_char(index) -> u32`
- `set_cursor_alt_char(index, char)`
- `get_cursor_style(index) -> u8`
- `set_cursor_style(index, style)`
  </action>
  <verify>
  ```bash
  cargo build -p spark-tui 2>&1 | head -30
  cargo test -p spark-tui interaction --no-fail-fast 2>&1 | tail -30
  ```
  </verify>
  <done>
  - CURSOR_CHAR, CURSOR_ALT_CHAR, CURSOR_STYLE arrays exist
  - Accessors work correctly
  - Arrays included in ensure_capacity, clear_at_index, reset
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cursor module tests</name>
  <files>src/state/cursor.rs</files>
  <action>
Add tests to `src/state/cursor.rs`:

1. **test_cursor_show_hide** - Toggle visibility, verify state

2. **test_cursor_move_to** - Move cursor, verify position state

3. **test_cursor_shape** - Set different shapes, verify state

4. **test_cursor_save_restore** - Save/restore cycle

5. **test_reset_cursor_state** - Reset returns to defaults

Note: These tests verify internal state, not actual terminal output (which can't be tested in unit tests).

Add integration test in tests/cursor_test.rs (optional):
- Actually run cursor commands and visually verify (for manual testing)
  </action>
  <verify>
  ```bash
  cargo test -p spark-tui cursor --no-fail-fast 2>&1 | tail -30
  ```
  </verify>
  <done>
  - State management tests pass
  - Cursor module is testable
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
cargo build -p spark-tui

# All tests pass
cargo test -p spark-tui cursor
cargo test -p spark-tui interaction

# Module exports
grep -r "pub mod cursor" src/state/mod.rs
```
</verification>

<success_criteria>
- [ ] `src/state/cursor.rs` provides clean terminal cursor API
- [ ] Cursor state tracked internally
- [ ] CURSOR_CHAR, CURSOR_ALT_CHAR, CURSOR_STYLE arrays exist in interaction.rs
- [ ] All tests pass
- [ ] No compiler warnings
</success_criteria>

<output>
After completion, create `.planning/phases/05-cursor-system/05-02-SUMMARY.md`
</output>
