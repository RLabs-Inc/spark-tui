---
phase: 05-cursor-system
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/state/drawn_cursor.rs
  - src/state/mod.rs
  - src/primitives/input.rs
autonomous: true

must_haves:
  truths:
    - "Cursor blink starts when Input gains focus"
    - "Cursor blink stops when Input loses focus"
    - "Cursor is always visible (no blink) when Input not focused"
    - "Cursor style can be configured per Input"
  artifacts:
    - path: "src/state/drawn_cursor.rs"
      provides: "Drawn cursor management with blink integration"
      min_lines: 150
      exports: ["create_cursor", "dispose_cursor", "DrawnCursor"]
  key_links:
    - from: "src/state/drawn_cursor.rs"
      to: "src/state/animate.rs"
      via: "subscribe_to_blink"
      pattern: "animate::subscribe_to_blink"
    - from: "src/state/drawn_cursor.rs"
      to: "src/state/focus.rs"
      via: "focus callbacks"
      pattern: "focus::register_callbacks"
---

<objective>
Create the drawn cursor module and integrate with Input component.

Purpose: Inputs need visual cursor feedback with configurable style and blink animation that syncs with focus state.

Output: `src/state/drawn_cursor.rs` module and updated Input component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cursor-system/05-CONTEXT.md
@.planning/phases/05-cursor-system/05-RESEARCH.md
@.planning/phases/05-cursor-system/05-01-SUMMARY.md
@.planning/phases/05-cursor-system/05-02-SUMMARY.md
@src/state/focus.rs
@src/state/animate.rs
@src/primitives/input.rs
@src/primitives/types.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create drawn cursor module with cursor_visible getter</name>
  <files>src/state/drawn_cursor.rs, src/state/mod.rs</files>
  <action>
Create `src/state/drawn_cursor.rs` following TypeScript drawnCursor.ts pattern:

1. **DrawnCursorConfig struct**:
   ```rust
   pub struct DrawnCursorConfig {
       pub style: CursorStyle,      // Block, Bar, Underline
       pub char: Option<char>,       // Custom char (overrides style)
       pub blink: bool,              // Enable blink (default: true)
       pub fps: u8,                  // Blink FPS (default: 2)
       pub alt_char: Option<char>,   // Alt char for off phase
   }
   ```

2. **DrawnCursor struct** - Control object returned by create_cursor:
   ```rust
   pub struct DrawnCursor {
       index: usize,
       // Internal state for cleanup
   }

   impl DrawnCursor {
       pub fn set_position(&self, pos: u16);
       pub fn get_position(&self) -> u16;
       pub fn show(&self);   // Manual override
       pub fn hide(&self);   // Manual override
       pub fn is_visible(&self) -> bool;
   }
   ```

3. **Active cursors registry** - `HashMap<usize, CursorEntry>` where CursorEntry holds:
   - unsubscribe_blink: Option<Box<dyn FnOnce()>>
   - unsubscribe_focus: Box<dyn FnOnce()>
   - manual_visible: Signal<Option<bool>> (None = use blink, Some = override)

4. **create_cursor(index: usize, config: DrawnCursorConfig) -> DrawnCursor**:
   - Determine cursor char from style or custom char
   - Set cursor arrays using accessors from 05-02:
     - `interaction::set_cursor_char(index, char_code)`
     - `interaction::set_cursor_alt_char(index, alt_char_code)`
     - `interaction::set_cursor_style(index, style_u8)`
     - `interaction::set_cursor_blink_fps(index, fps)`
   - Create manual_visible signal
   - Register focus callbacks:
     - on_focus: subscribe to blink if enabled
     - on_blur: unsubscribe from blink
   - **CRITICAL: Create and set cursor_visible getter closure**:
     ```rust
     let manual_visible_clone = manual_visible.clone();
     let fps = config.fps;
     let blink_enabled = config.blink;

     let getter = move || -> bool {
         // 1. Check manual override first
         if let Some(manual) = manual_visible_clone.get() {
             return manual;
         }

         // 2. Check focus state
         let focused = focus::is_focused(index);
         if !focused {
             return true; // Not focused = show cursor (no blink)
         }

         // 3. If focused but blink disabled, always visible
         if !blink_enabled {
             return true;
         }

         // 4. If focused and blink enabled, return blink phase
         animate::get_blink_phase(fps)
     };

     interaction::set_cursor_visible_getter(index, getter);
     ```
   - Store in active cursors registry
   - Return DrawnCursor control object

5. **dispose_cursor(index: usize)**:
   - Get entry from registry
   - Call unsubscribe functions
   - Clear cursor arrays
   - Remove from registry

6. **Cursor style constants**:
   ```rust
   pub const CURSOR_CHAR_BLOCK: u32 = 0;        // Special: inverse
   pub const CURSOR_CHAR_BAR: u32 = 0x2502;     // |
   pub const CURSOR_CHAR_UNDERLINE: u32 = 0x5F; // _
   ```

Update `src/state/mod.rs` to export drawn_cursor module.
  </action>
  <verify>
  ```bash
  cargo build -p spark-tui 2>&1 | head -30
  grep -r "pub fn create_cursor" src/state/drawn_cursor.rs
  grep -r "set_cursor_visible_getter" src/state/drawn_cursor.rs
  ```
  </verify>
  <done>
  - DrawnCursorConfig and DrawnCursor types exist
  - create_cursor sets up blink subscription via focus callbacks
  - cursor_visible getter created as closure checking: manual override -> focus state -> blink phase
  - dispose_cursor cleans up all resources
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate drawn cursor into Input component</name>
  <files>src/primitives/input.rs</files>
  <action>
Update `src/primitives/input.rs` to use drawn cursor:

1. **In input() function, after setting up focus callbacks**:
   - Read cursor config from props.cursor (or use defaults)
   - Call `drawn_cursor::create_cursor(index, config)` with:
     - style from config or CursorStyle::Block
     - blink from config or true
     - fps from config or 2
   - Store the DrawnCursor in cleanup scope

2. **Remove the existing manual cursor_visible set**:
   - Delete: `interaction::set_cursor_visible(index, true);`
   - The drawn cursor module now manages visibility via getter

3. **In cleanup closure**:
   - Call `drawn_cursor::dispose_cursor(index)` before release_index

4. **Handle cursor config props**:
   - If props.cursor is Some, extract style, blink, fps
   - If props.cursor is None, use defaults (Block, blink=true, fps=2)

Note: The cursor position is already managed by the Input component via cursor_pos signal. The drawn cursor module just adds blink and visibility management.
  </action>
  <verify>
  ```bash
  cargo build -p spark-tui 2>&1 | head -30
  cargo test -p spark-tui input --no-fail-fast 2>&1 | tail -30
  ```
  </verify>
  <done>
  - Input creates drawn cursor on mount
  - Input disposes drawn cursor on cleanup
  - Cursor config from props is respected
  - Existing Input tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Add drawn cursor tests</name>
  <files>src/state/drawn_cursor.rs</files>
  <action>
Add tests to `src/state/drawn_cursor.rs`:

1. **test_create_cursor_sets_arrays** - Verify cursor_char, cursor_style set correctly

2. **test_cursor_visible_when_not_focused** - Cursor visible = true when not focused (no blink)

3. **test_cursor_blinks_when_focused** - Focus triggers blink subscription

4. **test_cursor_stops_blink_on_blur** - Blur unsubscribes from blink

5. **test_dispose_cursor_cleans_up** - Arrays cleared, registry entry removed

6. **test_manual_show_hide_override** - show()/hide() override blink

7. **test_cursor_styles** - Block, Bar, Underline set correct char

8. **test_custom_cursor_char** - Custom char overrides style preset

Each test should use reset functions to ensure clean state.
  </action>
  <verify>
  ```bash
  cargo test -p spark-tui drawn_cursor -- --test-threads=1 2>&1 | tail -50
  ```
  </verify>
  <done>
  - All drawn cursor tests pass
  - Blink integration works correctly
  - Focus callbacks fire appropriately
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
cargo build -p spark-tui

# All tests pass
cargo test -p spark-tui drawn_cursor -- --test-threads=1
cargo test -p spark-tui input --no-fail-fast

# Module integrates correctly
grep -r "drawn_cursor::create_cursor" src/primitives/input.rs
```
</verification>

<success_criteria>
- [ ] `src/state/drawn_cursor.rs` exists with create/dispose functions
- [ ] Blink starts on focus, stops on blur
- [ ] cursor_visible getter integrates blink phase correctly via closure
- [ ] Input component creates and disposes cursor
- [ ] All tests pass
- [ ] No compiler warnings
</success_criteria>

<output>
After completion, create `.planning/phases/05-cursor-system/05-03-SUMMARY.md`
</output>
